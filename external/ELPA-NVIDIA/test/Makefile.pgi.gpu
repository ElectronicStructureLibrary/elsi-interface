# Modules needed at RZG:
# module load impi/4.0.0 mkl/10.3 cuda/4.0 pgi/12.5
# ------------------------------------------------------------------------------
# Please set the variables below according to your system!
# ------------------------------------------------------------------------------
# Settings for Intel Fortran (Linux):
#

PREF=

F90=$(PREF) mpif90 -g -pg  -O4 -I/shared/apps/intel/Compiler/11.1/069/mkl/include -tp=sandybridge -ta=tesla:lineinfo,cuda6.5 -DGPU_VERSION

FFLAGS = -O4
F90FLAGS = $(FFLAGS)
F90OPT = $(F90)
ARCHITECTURE = PGI

#LIBS = cuUtils.o ev_tridi_band_gpu_c_v2.o  -Mcuda -L /shared/apps/rhel-6.2/intel/parallel-studio-xe-2013/mkl/lib/intel64/ \
  -I /shared/apps/rhel-6.2/intel/parallel-studio-xe-2013/mkl/include -lmkl_intel_lp64 -lgfortran \
   -lmkl_sequential -lmkl_core -lpthread /shared/apps/pgi/centos-6.2/linux86-64/2014/mpi/mpich/lib/libscalapack.a -lmpich  -lcublas \
interface_cuda.o interface_c_kernel.o -lcudart

LIBS = cuUtils.o ev_tridi_band_gpu_c_v2.o  -Mcuda -L /shared/apps/rhel-6.2/intel/parallel-studio-xe-2013/mkl/lib/intel64/ \
  -I /shared/apps/rhel-6.2/intel/parallel-studio-xe-2013/mkl/include -lmkl_intel_lp64 -lgfortran \
   -lmkl_sequential -lmkl_core -lpthread /shared/apps/pgi/centos-6.2/linux86-64/2014/mpi/mpich/lib/libscalapack.a -lcublas \
interface_cuda.o interface_c_kernel.o -lcudart
#
# ------------------------------------------------------------------------------

#all: test_real read_real test_complex test_real_gen read_real_gen test_complex_gen test_real2 test_complex2
all: test_real2_gpu  test_complex2_gpu
test_real: test_real.o elpa1.o 
	$(F90) -o $@ test_real.o elpa1.o $(LIBS)

read_real: read_real.o elpa1.o 
	$(F90) -o $@ read_real.o elpa1.o  $(LIBS)

test_complex: test_complex.o elpa1.o 
	$(F90) -o $@ test_complex.o elpa1.o  $(LIBS)

test_real_gen: test_real_gen.o elpa1.o 
	$(F90) -o $@ test_real_gen.o elpa1.o $(LIBS)

read_real_gen: read_real_gen.o elpa1.o 
	$(F90) -o $@ read_real_gen.o elpa1.o  $(LIBS)

test_complex_gen: test_complex_gen.o elpa1.o 
	$(F90) -o $@ test_complex_gen.o elpa1.o  $(LIBS)

test_real2_gpu: test_real2.o elpa1.o elpa2.o elpa2_kernels.o ev_tridi_band_gpu_c_v2.o cuUtils.o 
	$(F90) -o $@ test_real2.o elpa1.o elpa2.o elpa_pdgeqrf.o elpa_pdlarfb.o elpa_qrkernels.o tum_utils.o elpa2_kernels.o $(LIBS)

test_complex2_gpu: test_complex2.o elpa1.o elpa2.o elpa2_kernels.o  cuUtils.o ev_tridi_band_gpu_c_v2.o 
	$(F90) -o $@ test_complex2.o elpa1.o elpa2.o elpa_pdgeqrf.o elpa_pdlarfb.o elpa_qrkernels.o tum_utils.o elpa2_kernels.o  $(LIBS)

test_real.o: test_real.f90 elpa1.o 
	$(F90) -c $<

read_real.o: read_real.f90 elpa1.o
	$(F90) -c $<

tum_utils.o: ../src/elpa_qr/tum_utils.f90
	$(F90) -c $<

interface_cuda.o: ../src/interface_cuda.f90
	$(F90) -c $<

interface_c_kernel.o: ../src/interface_c_kernel.f90
	$(F90) -c $<

elpa_qrkernels.o: ../src/elpa_qr/elpa_qrkernels.f90
	$(F90) -c $<

elpa_pdlarfb.o: ../src/elpa_qr/elpa_pdlarfb.f90 tum_utils.o elpa_qrkernels.o
	$(F90) -c $<

elpa_pdgeqrf.o: ../src/elpa_qr/elpa_pdgeqrf.f90 elpa1.o tum_utils.o elpa_pdlarfb.o elpa_qrkernels.o
	$(F90) -c $<

test_complex.o: test_complex.f90 elpa1.o
	$(F90) -c $<

test_real_gen.o: test_real_gen.f90 elpa1.o
	$(F90) -c $<

read_real_gen.o: read_real_gen.f90 elpa1.o
	$(F90) -c $<

test_complex_gen.o: test_complex_gen.f90 elpa1.o
	$(F90) -c $<

test_real2.o: test_real2.F90 elpa1.o elpa2.o
	$(F90) -c $<

test_complex2.o: test_complex2.F90 elpa1.o elpa2.o
	$(F90) -c $<

elpa1.o: ../src/elpa1.f90
	$(F90) -c $<

elpa2.o:	elpa1.o\
		elpa_pdgeqrf.o\
                interface_cuda.o\
		interface_c_kernel.o\
		../src/elpa2.F90\
		../src/tridiag_band_real.f90\
		../src/tridiag_band_real_gpu_v1.f90\
		../src/bandred_real.f90\
		../src/bandred_real_gpu_v2.f90\
		../src/ev_band_full.f90\
		../src/ev_band_full_gpu_v1.f90\
		../src/ev_tridi_band.f90\
		../src/ev_tridi_band_gpu_v3.f90\
		../src/ev_tridi_band_complex_gpu_v3.f90\
		../src/ev_band_full_complex_gpu_v1.f90\
		../src/bandred_complex_gpu_v2.f90\
		../src/tridiag_band_complex.f90
	$(F90) -c ../src/elpa2.F90

elpa2_kernels.o: ../src/elpa2_kernels.f90
	$(F90OPT) -c ../src/elpa2_kernels.f90


ev_tridi_band_gpu_c_v2.o: ../src/ev_tridi_band_gpu_c_v2.cu
	#nvcc -g -G -lineinfo -arch sm_35 -O -c --ptxas-options=-v  ../src/ev_tridi_band_gpu_c_v2.cu
	nvcc -g -lineinfo -arch sm_35 -O3 -c ../src/ev_tridi_band_gpu_c_v2.cu

cuUtils.o: ../src/cuUtils.cu
	#nvcc -g -G -lineinfo -arch sm_35 -O -c --ptxas-options=-v ../src/cuUtils.cu
	nvcc -g -lineinfo -arch sm_35 -O3 -c ../src/cuUtils.cu

clean:
	rm -f *.o *.mod test_real test_complex test_real_gen test_complex_gen test_real2_gpu test_complex2_gpu read_real read_real_gen



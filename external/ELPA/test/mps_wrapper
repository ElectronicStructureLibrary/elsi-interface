#!/bin/bash -e

#export CUDA_MPS_CLIENT=1

#lrank=$OMPI_COMM_WORLD_LOCAL_RANK
lrank=$(($PMI_RANK % $PBS_NUM_PPN))
echo global rank $PMI_RANK is local rank $lrank

case ${lrank} in
0)
    echo case 0 
    export CUDA_VISIBLE_DEVICES=0 
    $*;;
1) 
    echo case 1 
    export CUDA_VISIBLE_DEVICES=0
    $*;;
2) 
    echo case 2 
    export CUDA_VISIBLE_DEVICES=1
    $*;;
3) 
    echo case 3 
    export CUDA_VISIBLE_DEVICES=1
    $*;;
4) 
    echo case 4 
    export CUDA_VISIBLE_DEVICES=2
    $*;;
5) 
    echo case 5 
    export CUDA_VISIBLE_DEVICES=2
    $*;;
6) 
    echo case 6 
    export CUDA_VISIBLE_DEVICES=3
    $*;;
7) 
    echo case 7 
    export CUDA_VISIBLE_DEVICES=3
    $*;
esac

CC = $(MPICC)

CPU=$(shell uname -m | sed "s/\\ /_/g")
SYS=$(shell uname -s)

all: libparmetis libsuperlu

libparmetis:
	@echo Start building parMetis...
	cd $(PEXSI_DIR)/external/parMetis && make config prefix=$(PEXSI_DIR)/external/parMetis
	cd $(PEXSI_DIR)/external/parMetis/build/$(SYS)-$(CPU) && make && make install
	mkdir -p $(PEXSI_DIR)/external/include
	mkdir -p $(PEXSI_DIR)/external/lib
	-cp `find $(PEXSI_DIR)/external/parMetis/include -name parmetis.h` $(PEXSI_DIR)/external/include/.
	-cp `find $(PEXSI_DIR)/external/parMetis/metis/include -name metis.h` $(PEXSI_DIR)/external/include/.
	-cp `find $(PEXSI_DIR)/external/parMetis/build/$(SYS)-$(CPU) -name libparmetis.a` $(PEXSI_DIR)/external/lib/.
	-cp `find $(PEXSI_DIR)/external/parMetis/build/$(SYS)-$(CPU) -name libmetis.a` $(PEXSI_DIR)/external/lib/.
	mkdir -p $(PEXSI_DIR)/lib
	-cp $(PEXSI_DIR)/external/lib/libparmetis.a $(PEXSI_DIR)/lib/.
	-cp $(PEXSI_DIR)/external/lib/libmetis.a $(PEXSI_DIR)/lib/.
	@echo parMetis installed.

libsuperlu:
	@echo Start building SuperLU...
	cd $(PEXSI_DIR)/external && cp make.inc.superlu SuperLU/make.inc
	cd $(PEXSI_DIR)/external/SuperLU && make
	mkdir -p $(PEXSI_DIR)/external/include
	mkdir -p $(PEXSI_DIR)/external/lib
	-cp $(PEXSI_DIR)/external/SuperLU/SRC/*.h $(PEXSI_DIR)/external/include/.
	-cp $(PEXSI_DIR)/external/lib/libsuperlu.a $(PEXSI_DIR)/lib/.
	@echo SuperLU installed.

clean:
	cd $(PEXSI_DIR)/external/SuperLU && make clean
	rm -rf $(PEXSI_DIR)/external/include
	rm -rf $(PEXSI_DIR)/external/lib
	rm -rf $(PEXSI_DIR)/external/parMetis/build
	rm -rf $(PEXSI_DIR)/external/parMetis/bin
	rm -f $(PEXSI_DIR)/external/parMetis/lib/libparmetis.a $(PEXSI_DIR)/lib/libparmetis.a $(PEXSI_DIR)/lib/libmetis.a $(PEXSI_DIR)/lib/libsuperlu.a
